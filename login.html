<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ - çŸ­æ­Œã‚½ãƒ ãƒªã‚¨</title>
    
    <link rel="icon" href="https://momongacarnival.com/assets/momonga-500x500.png">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>

    <style>
        .auth-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .auth-btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-family: inherit; font-weight: bold; margin-right: 5px; width: 100%; margin-bottom: 10px;}
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* â˜…è¿½åŠ ï¼šã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ›ãƒãƒ¼ã—ãŸæ™‚ã«å°‘ã—é€éã•ã›ã¦ã€æŠ¼ã›ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹ */
        .site-title-link {
            text-decoration: none;
            color: inherit;
            transition: opacity 0.2s;
        }
        .site-title-link:hover {
            opacity: 0.7;
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="container">
        
        <h1 style="margin-top: 0; margin-bottom: 30px; text-align: center;">
            <a href="index.html" class="site-title-link">ğŸµ çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰</a>
        </h1>

        <div style="background: #fff3e0; padding: 30px; border-radius: 8px; max-width: 400px; margin: 0 auto;">
            <h3 style="margin-top: 0; color: #d35400; text-align: center;">ğŸ‘¤ æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</h3>

            <div id="unauthView">
                <input type="email" id="emailInput" class="auth-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <input type="password" id="passwordInput" class="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚8æ–‡å­—ä»¥ä¸Š)">
                <input type="text" id="nicknameInput" class="auth-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (æ–°è¦ç™»éŒ²æ™‚ã®ã¿)">
                
                <button class="auth-btn" onclick="logIn()" style="background: #d35400;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="auth-btn" onclick="signUp()" style="background: #e67e22;">æ–°è¦ç™»éŒ²ã™ã‚‹</button>
                <p id="authMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>

            <div id="verifyView" style="display: none;">
                <p style="font-size: 0.9em;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input type="text" id="verifyCodeInput" class="auth-input" placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰">
                <button class="auth-btn" onclick="verifyCode()" style="background: #e67e22;">ç¢ºèªã—ã¦ç™»éŒ²å®Œäº†</button>
                <p id="verifyMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>
        </div>
    </div>
</div>

<script>
    // Cognitoã®è¨­å®š
    const poolData = {
        UserPoolId: 'ap-northeast-1_eCaiHRE4i', 
        ClientId: '43kh9fab4798b32548q9ap1nmn' 
    };
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
    let cognitoUser = null; 

    // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«å¼¾ãè¿”ã™
    window.onload = function() {
        if(localStorage.getItem('tanka_nickname')) {
            window.location.href = 'index.html';
        }
    }

    function signUp() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const nickname = document.getElementById('nicknameInput').value;
        const msg = document.getElementById('authMessage');

        if(!email || !password || !nickname) {
            msg.innerText = 'â€»å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„'; return;
        }
        msg.innerText = "é€šä¿¡ä¸­...";

        const attributeList = [ new AmazonCognitoIdentity.CognitoUserAttribute({ Name: 'nickname', Value: nickname }) ];

        userPool.signUp(email, password, attributeList, null, function(err, result){
            if (err) { msg.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err)); return; }
            cognitoUser = result.user;
            document.getElementById('unauthView').style.display = 'none';
            document.getElementById('verifyView').style.display = 'block';
        });
    }

    function verifyCode() {
        const code = document.getElementById('verifyCodeInput').value;
        const msg = document.getElementById('verifyMessage');
        if(!cognitoUser || !code) { msg.innerText = "â€»ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
        msg.innerText = "ç¢ºèªä¸­...";

        cognitoUser.confirmRegistration(code, true, function(err, result) {
            if (err) { msg.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err)); return; }
            alert("ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼ç¶šã‘ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            document.getElementById('verifyView').style.display = 'none';
            document.getElementById('unauthView').style.display = 'block';
            document.getElementById('nicknameInput').value = ''; 
        });
    }

    function logIn() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const msg = document.getElementById('authMessage');

        if(!email || !password) { msg.innerText = 'â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
        msg.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";

        const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: email, Password: password });
        cognitoUser = new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });

        cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: function (result) {
                const accessToken = result.getAccessToken().getJwtToken();
                cognitoUser.getUserAttributes(function(err, attributes) {
                    if (err) { msg.innerText = err.message; return; }
                    let nicknameStr = "";
                    for (let i = 0; i < attributes.length; i++) {
                        if (attributes[i].getName() === 'nickname') nicknameStr = attributes[i].getValue();
                    }
                    localStorage.setItem('tanka_nickname', nicknameStr);
                    localStorage.setItem('tanka_access_token', accessToken); 
                    
                    // â˜…ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã—ãŸã‚‰ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸è‡ªå‹•ã§æˆ»ã‚‹ï¼
                    window.location.href = 'index.html';
                });
            },
            onFailure: function(err) { msg.innerText = "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: " + (err.message || JSON.stringify(err)); },
        });
    }
</script>

</body>
</html>