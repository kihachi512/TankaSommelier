<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³ - çŸ­æ­Œã‚½ãƒ ãƒªã‚¨</title>
    
    <link rel="icon" href="https://momongacarnival.com/assets/momonga-500x500.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
    <script src="config.js"></script>
    <script src="common.js"></script>

    <style>
        .auth-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .auth-btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-family: inherit; margin-right: 5px; width: 100%; margin-bottom: 10px;}
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .site-title-link { text-decoration: none; color: inherit; transition: opacity 0.2s; }
        .site-title-link:hover { opacity: 0.7; }
        
        /* â˜…ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .password-wrapper { position: relative; width: 100%; display: flex; align-items: center; margin-bottom: 10px; }
        .password-wrapper .auth-input { margin-bottom: 0; padding-right: 40px; } /* å…¥åŠ›æ¬„ã®æ–‡å­—ãŒã‚¢ã‚¤ã‚³ãƒ³ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã« */
        .toggle-password {
            position: absolute; right: 10px; cursor: pointer;
            color: #888; display: flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; transition: color 0.2s;
        }
        .toggle-password:hover { color: #555; }
        .toggle-password svg { width: 20px; height: 20px; stroke: currentColor; }
        
        .text-link { color: #d35400; font-size: 0.85em; text-decoration: underline; cursor: pointer; text-align: center; display: block; margin-top: 10px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="container">
        
        <h1 style="margin-top: 0; margin-bottom: 30px; text-align: center;">
            <a href="index.html" class="site-title-link">ğŸµ çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰</a>
        </h1>

        <div style="background: #fff3e0; padding: 30px; border-radius: 8px; max-width: 400px; margin: 0 auto;">
            <h3 style="margin-top: 0; color: #d35400; text-align: center;">ğŸ‘¤ æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</h3>

            <div id="unauthView">
                <input type="email" id="emailInput" class="auth-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                
                <div class="password-wrapper">
                    <input type="password" id="passwordInput" class="auth-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (å¤§æ–‡å­—å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã§8æ–‡å­—ä»¥ä¸Š)">
                    <span class="toggle-password" onclick="toggleVisibility('passwordInput', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </span>
                </div>
                
                <input type="text" id="nicknameInput" class="auth-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  (æ–°è¦ç™»éŒ²æ™‚ã®ã¿)">
                
                <button class="auth-btn" onclick="logIn()" style="background: #d35400;">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button class="auth-btn" onclick="signUp()" style="background: #e67e22;">æ–°è¦ç™»éŒ²ã™ã‚‹</button>
                
                <span class="text-link" onclick="showForgotPassword()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹ã¯ã“ã¡ã‚‰</span>
                
                <p id="authMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>

            <div id="verifyView" style="display: none;">
                <p style="font-size: 0.9em;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input type="text" id="verifyCodeInput" class="auth-input" placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰">
                <button class="auth-btn" onclick="verifyCode()" style="background: #e67e22;">ç¢ºèªã—ã¦ç™»éŒ²å®Œäº†</button>
                <p id="verifyMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>

            <div id="forgotPasswordView" style="display: none;">
                <p style="font-size: 0.9em;">ç™»éŒ²ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šç”¨ã®ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã™ã€‚</p>
                <input type="email" id="forgotEmailInput" class="auth-input" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <button class="auth-btn" onclick="sendResetCode()" style="background: #e67e22;">ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡</button>
                <span class="text-link" onclick="showLoginView()">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</span>
                <p id="forgotMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>

            <div id="resetPasswordView" style="display: none;">
                <p style="font-size: 0.9em;">ãƒ¡ãƒ¼ãƒ«ã«å±Šã„ãŸã‚³ãƒ¼ãƒ‰ã¨ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                <input type="text" id="resetCodeInput" class="auth-input" placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰">
                
                <div class="password-wrapper">
                    <input type="password" id="newPasswordInput" class="auth-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <span class="toggle-password" onclick="toggleVisibility('newPasswordInput', this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                    </span>
                </div>

                <button class="auth-btn" onclick="confirmNewPassword()" style="background: #d35400;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
                <p id="resetMessage" style="color: red; margin-top: 10px; font-size: 0.9em; text-align: center;"></p>
            </div>

        </div>
    </div>
    <footer style="margin-top: 80px; text-align: center; font-size: 0.85rem; color: var(--border-color);">
        <ul style="list-style: none; padding: 0; display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">
          <li><a href="https://momongacarnival.com/privacy/index.html" style="color: var(--border-color); text-decoration: underline;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
          <li><a href="https://momongacarnival.com/contact/index.html" style="color: var(--border-color); text-decoration: underline;">ãŠå•ã„åˆã‚ã›</a></li>
        </ul>
        <p>&copy; ã•ã™ã‚‰ã„ã®ãƒ¢ãƒ¢ãƒ³ã‚¬ã‚«ãƒ¼ãƒ‹ãƒãƒ«</p>
      </footer>
</div>

<script>
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(CONFIG.COGNITO);
    let cognitoUser = null; 
    let resetUser = null; 

    // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«å¼¾ãè¿”ã™å‡¦ç†ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼
    window.onload = function() {
        const nickname = localStorage.getItem('tanka_nickname');
        const sub = localStorage.getItem('tanka_sub');

        // â˜…åå‰ã‚‚å›ºæœ‰IDã‚‚ä¸¡æ–¹æƒã£ã¦ã„ã‚‹ã€Œå®Œå…¨ãªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã€ãªã‚‰ãƒˆãƒƒãƒ—ã¸æˆ»ã™
        if(nickname && sub) {
            window.location.href = 'index.html';
        } else {
            // â˜…å¤ã„ä¸­é€”åŠç«¯ãªãƒ‡ãƒ¼ã‚¿ï¼ˆåå‰ã ã‘æ®‹ã£ã¦ã„ã‚‹ç­‰ï¼‰ãŒã‚ã‚Œã°ã€ç¶ºéº—ã«ãŠæƒé™¤ã™ã‚‹ï¼
            localStorage.removeItem('tanka_nickname');
            localStorage.removeItem('tanka_access_token');
            localStorage.removeItem('tanka_sub');
        }
    }

    // ==========================================
    // UI åˆ‡ã‚Šæ›¿ãˆãƒ»ä¾¿åˆ©æ©Ÿèƒ½
    // ==========================================
    
    function hideAllViews() {
        document.getElementById('unauthView').style.display = 'none';
        document.getElementById('verifyView').style.display = 'none';
        document.getElementById('forgotPasswordView').style.display = 'none';
        document.getElementById('resetPasswordView').style.display = 'none';
    }

    function showLoginView() {
        hideAllViews();
        document.getElementById('unauthView').style.display = 'block';
    }

    function showForgotPassword() {
        hideAllViews();
        document.getElementById('forgotPasswordView').style.display = 'block';
    }

    // ==========================================
    // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
    // ==========================================

    function signUp() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const nickname = document.getElementById('nicknameInput').value;
        const msg = document.getElementById('authMessage');

        if(!email || !password || !nickname) {
            msg.innerText = 'â€»å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„'; return;
        }
        msg.innerText = "é€šä¿¡ä¸­...";

        // â˜…ã“ã“ã‚’ä¿®æ­£ï¼šnicknameã«åŠ ãˆã¦ã€emailã‚‚å±æ€§ã¨ã—ã¦è¿½åŠ ã™ã‚‹ï¼
        const attributeList = [ 
            new AmazonCognitoIdentity.CognitoUserAttribute({ Name: 'nickname', Value: nickname }),
            new AmazonCognitoIdentity.CognitoUserAttribute({ Name: 'email', Value: email }) 
        ];

        userPool.signUp(email, password, attributeList, null, function(err, result){
            if (err) { msg.innerText = translateError(err); return; }
            cognitoUser = result.user;
            hideAllViews();
            document.getElementById('verifyView').style.display = 'block';
        });
    }

    function verifyCode() {
        const code = document.getElementById('verifyCodeInput').value;
        const msg = document.getElementById('verifyMessage');
        if(!cognitoUser || !code) { msg.innerText = "â€»ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
        msg.innerText = "ç¢ºèªä¸­...";

        cognitoUser.confirmRegistration(code, true, async function(err, result) {
            if (err) { msg.innerText = translateError(err); return; }
            await customAlert("ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼ç¶šã‘ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
            showLoginView();
            document.getElementById('nicknameInput').value = ''; 
        });
    }

    function logIn() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        const msg = document.getElementById('authMessage');

        if(!email || !password) { msg.innerText = 'â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
        msg.innerText = "ãƒ­ã‚°ã‚¤ãƒ³ä¸­...";

        const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({ Username: email, Password: password });
        cognitoUser = new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });

        cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: function (result) {
                const accessToken = result.getAccessToken().getJwtToken();
                cognitoUser.getUserAttributes(function(err, attributes) {
                    if (err) { msg.innerText = translateError(err); return; }
                    let nicknameStr = "";
                    let subStr = ""; 
                    for (let i = 0; i < attributes.length; i++) {
                        if (attributes[i].getName() === 'nickname') nicknameStr = attributes[i].getValue();
                        if (attributes[i].getName() === 'sub') subStr = attributes[i].getValue();
                    }
                    localStorage.setItem('tanka_nickname', nicknameStr);
                    localStorage.setItem('tanka_access_token', accessToken); 
                    localStorage.setItem('tanka_sub', subStr); 
                    window.location.href = 'index.html';
                });
            },
            onFailure: function(err) { 
                // â˜…è¿½åŠ ï¼šã‚‚ã—ã€Œãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒçµ‚ã‚ã£ã¦ã„ãªã„ã€ã‚¨ãƒ©ãƒ¼ã ã£ãŸã‚‰æ•‘æ¸ˆã™ã‚‹ï¼
                if (err.code === 'UserNotConfirmedException') {
                    msg.innerText = "";
                    customAlert("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚\næ–°ã—ãç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å†é€ã—ã¾ã—ãŸã®ã§ã€å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚").then(() => {
                        // æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’å†é€ã—ã¦ã‚ã’ã‚‹è¦ªåˆ‡è¨­è¨ˆ
                        cognitoUser.resendConfirmationCode(function(err, result) {
                            if (err) {
                                customAlert("ã‚³ãƒ¼ãƒ‰ã®å†é€ã«å¤±æ•—ã—ã¾ã—ãŸ: " + translateError(err));
                                return;
                            }
                            // ç”»é¢ã‚’ã€Œã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ï¼ˆverifyViewï¼‰ã€ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                            hideAllViews();
                            document.getElementById('verifyView').style.display = 'block';
                        });
                    });
                    return;
                }
                
                // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–“é•ã„ãªã©ï¼‰ã¯ãã®ã¾ã¾è¡¨ç¤º
                msg.innerText = translateError(err); 
            },
        });
    }

    function sendResetCode() {
        const email = document.getElementById('forgotEmailInput').value;
        const msg = document.getElementById('forgotMessage');
        
        if(!email) { msg.innerText = "â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
        msg.innerText = "é€ä¿¡ä¸­...";

        resetUser = new AmazonCognitoIdentity.CognitoUser({ Username: email, Pool: userPool });
        
        resetUser.forgotPassword({
            onSuccess: function (data) {},
            onFailure: function(err) { msg.innerText = translateError(err); },
            inputVerificationCode: function(data) {
                msg.innerText = "";
                hideAllViews();
                document.getElementById('resetPasswordView').style.display = 'block';
            }
        });
    }

    function confirmNewPassword() {
        const code = document.getElementById('resetCodeInput').value;
        const newPassword = document.getElementById('newPasswordInput').value;
        const msg = document.getElementById('resetMessage');

        if(!code || !newPassword) { msg.innerText = "â€»ã‚³ãƒ¼ãƒ‰ã¨æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; return; }
        msg.innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ä¸­...";

        resetUser.confirmPassword(code, newPassword, {
            onSuccess: async function() {
                await customAlert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå®Œäº†ã—ã¾ã—ãŸï¼æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                showLoginView();
                document.getElementById('passwordInput').value = '';
            },
            onFailure: function(err) { msg.innerText = translateError(err); }
        });
    }
</script>

</body>
</html>