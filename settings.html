<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š - çŸ­æ­Œã‚½ãƒ ãƒªã‚¨</title>
    
    <link rel="icon" href="https://momongacarnival.com/assets/momonga-500x500.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.7/dist/amazon-cognito-identity.min.js"></script>
    <script src="config.js"></script>
    <script src="common.js"></script>

    <style>
        .settings-card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; text-align: left; }
        .settings-card h3 { margin-top: 0; color: #2c5e3b; border-bottom: 2px dashed #e0e0e0; padding-bottom: 10px; font-size: 1.2em;}
        .setting-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        .setting-btn { padding: 10px 15px; border: none; border-radius: 4px; color: white; cursor: pointer; font-family: inherit; background: #2c5e3b; transition: opacity 0.2s;}
        .setting-btn:hover { opacity: 0.8; }
        .setting-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .password-wrapper { position: relative; width: 100%; display: flex; align-items: center; margin-bottom: 15px; }
        .password-wrapper .setting-input { margin-bottom: 0; padding-right: 40px; }
        .toggle-password {
            position: absolute; right: 10px; cursor: pointer; color: #888; display: flex; align-items: center; justify-content: center; width: 24px; height: 24px;
        }
        .toggle-password svg { width: 20px; height: 20px; stroke: currentColor; }
        .site-title-link { text-decoration: none; color: inherit; transition: opacity 0.2s; }
        .site-title-link:hover { opacity: 0.7; }
        .msg { font-size: 0.9em; margin-top: 10px; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="container">
        <div id="userStatusBar" style="text-align: right; font-size: 0.9em; margin-bottom: 15px;"></div>

        <h1 style="margin-top: 0; margin-bottom: 30px; text-align: center;">
            <a href="index.html" class="site-title-link">ğŸµ çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰</a>
        </h1>

        <h2 style="color: #333; margin-bottom: 20px;">âš™ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š</h2>

        <div class="settings-card">
            <h3>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã®å¤‰æ›´</h3>
            <input type="text" id="newNicknameInput" class="setting-input" placeholder="æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
            <button class="setting-btn" id="btnNickname" onclick="changeNickname()">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹</button>
            <div id="msgNickname" class="msg"></div>
        </div>

        <div class="settings-card">
            <h3>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ç¢ºèªã‚³ãƒ¼ãƒ‰ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚</p>
            
            <div id="emailUpdateArea">
                <input type="email" id="newEmailInput" class="setting-input" placeholder="æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
                <button class="setting-btn" id="btnEmail" onclick="changeEmail()">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›´æ–°ã™ã‚‹</button>
            </div>
            
            <div id="emailVerifyArea" style="display: none;">
                <p style="font-size: 0.85em; color: #d35400; margin-bottom: 10px;">â€»æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚</p>
                <input type="text" id="emailCodeInput" class="setting-input" placeholder="6æ¡ã®ç¢ºèªã‚³ãƒ¼ãƒ‰">
                <button class="setting-btn" id="btnVerifyEmail" onclick="verifyEmailCode()" style="background: #e67e22;">ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦å®Œäº†</button>
            </div>
            
            <div id="msgEmail" class="msg"></div>
        </div>

        <div class="settings-card">
            <h3>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´</h3>
            <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚€ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            
            <div class="password-wrapper">
                <input type="password" id="oldPasswordInput" class="setting-input" placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <span class="toggle-password" onclick="toggleVisibility('oldPasswordInput', this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </span>
            </div>

            <div class="password-wrapper">
                <input type="password" id="newPasswordInput" class="setting-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                <span class="toggle-password" onclick="toggleVisibility('newPasswordInput', this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </span>
            </div>

            <button class="setting-btn" id="btnPassword" onclick="changePassword()" style="background: #d35400;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹</button>
            <div id="msgPassword" class="msg"></div>
        </div>
    </div>
    
    <footer style="margin-top: 80px; text-align: center; font-size: 0.85rem; color: var(--border-color);">
        <ul style="list-style: none; padding: 0; display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">
          <li><a href="https://momongacarnival.com/privacy/index.html" style="color: var(--border-color); text-decoration: underline;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
          <li><a href="https://momongacarnival.com/contact/index.html" style="color: var(--border-color); text-decoration: underline;">ãŠå•ã„åˆã‚ã›</a></li>
        </ul>
        <p>&copy; ã•ã™ã‚‰ã„ã®ãƒ¢ãƒ¢ãƒ³ã‚¬ã‚«ãƒ¼ãƒ‹ãƒãƒ«</p>
    </footer>
</div>

<script>
    // Cognitoã®è¨­å®š
    const userPool = new AmazonCognitoIdentity.CognitoUserPool(CONFIG.COGNITO);
    const cognitoUser = userPool.getCurrentUser();

    // â˜…ä¿®æ­£ï¼š2ã¤ã® window.onload ã‚’1ã¤ã«çµ±åˆï¼
    window.onload = function() {
        checkLoginStatus();

        if (!cognitoUser) {
            alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
            window.location.href = 'login.html';
            return;
        }
        cognitoUser.getSession(function(err, session) {
            if (err) {
                alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
                window.location.href = 'login.html';
                return;
            }
            const currentNickname = localStorage.getItem('tanka_nickname');
            if (currentNickname) {
                document.getElementById('newNicknameInput').value = currentNickname;
            }
        });
    }

    // 1. ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†
    function changeNickname() {
        const newNickname = document.getElementById('newNicknameInput').value;
        const msgDiv = document.getElementById('msgNickname');
        const btn = document.getElementById('btnNickname');

        if (!newNickname) { msgDiv.innerText = "â€»æ–°ã—ã„ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; msgDiv.style.color = "red"; return; }
        
        btn.disabled = true;
        msgDiv.innerText = "Cognitoã‚’æ›´æ–°ä¸­...";
        msgDiv.style.color = "#333";

        const attributeList = [ new AmazonCognitoIdentity.CognitoUserAttribute({ Name: 'nickname', Value: newNickname }) ];

        cognitoUser.updateAttributes(attributeList, async function(err, result) {
            if (err) {
                btn.disabled = false;
                msgDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err));
                msgDiv.style.color = "red"; return;
            }

            localStorage.setItem('tanka_nickname', newNickname);
            msgDiv.innerText = "éå»ã®çŸ­æ­Œã®ç½²åã‚’æ›¸ãæ›ãˆã¦ã„ã¾ã™...";

            try {
                const accessToken = localStorage.getItem('tanka_access_token');
                const response = await fetch(CONFIG.API.SYNC, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': accessToken
                    },
                    body: JSON.stringify({ new_author: newNickname })
                });

                if (response.status === 401) {
                    alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
                    window.location.href = 'login.html'; return;
                }

                if (!response.ok) throw new Error('ç½²åã®åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');

                msgDiv.innerText = "âœ… ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã¨éå»ã®ç½²åã‚’ã™ã¹ã¦æ›´æ–°ã—ã¾ã—ãŸï¼";
                msgDiv.style.color = "#2c5e3b";
                
                // ä¸Šã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ã‚‚æœ€æ–°ã®åå‰ã«æ›´æ–°
                checkLoginStatus(); 

            } catch (error) {
                msgDiv.innerText = "âš ï¸ åå‰ã¯å¤‰æ›´ã•ã‚Œã¾ã—ãŸãŒã€éå»ã®æŠ•ç¨¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message;
                msgDiv.style.color = "#d35400";
            } finally {
                btn.disabled = false;
            }
        });
    }

    // 2-1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´è¦æ±‚ã‚’é€ä¿¡ã™ã‚‹å‡¦ç†
    function changeEmail() {
        const newEmail = document.getElementById('newEmailInput').value;
        const msgDiv = document.getElementById('msgEmail');
        const btn = document.getElementById('btnEmail');

        if (!newEmail) { msgDiv.innerText = "â€»æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; msgDiv.style.color = "red"; return; }
        
        btn.disabled = true;
        msgDiv.innerText = "æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ä¸­...";
        msgDiv.style.color = "#333";

        const attributeList = [ new AmazonCognitoIdentity.CognitoUserAttribute({ Name: 'email', Value: newEmail }) ];

        cognitoUser.updateAttributes(attributeList, function(err, result) {
            btn.disabled = false;
            if (err) {
                msgDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err));
                msgDiv.style.color = "red";
                return;
            }
            
            // æˆåŠŸã—ãŸã‚‰ã€ã‚³ãƒ¼ãƒ‰å…¥åŠ›ç”»é¢ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
            document.getElementById('emailUpdateArea').style.display = 'none';
            document.getElementById('emailVerifyArea').style.display = 'block';
            msgDiv.innerText = "";
        });
    }

    // 2-2. å±Šã„ãŸã‚³ãƒ¼ãƒ‰ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¤œè¨¼ã™ã‚‹å‡¦ç†
    function verifyEmailCode() {
        const code = document.getElementById('emailCodeInput').value;
        const msgDiv = document.getElementById('msgEmail');
        const btn = document.getElementById('btnVerifyEmail');

        if (!code) { msgDiv.innerText = "â€»ç¢ºèªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; msgDiv.style.color = "red"; return; }

        btn.disabled = true;
        msgDiv.innerText = "ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªä¸­...";
        msgDiv.style.color = "#333";

        cognitoUser.verifyAttribute('email', code, {
            onSuccess: function() {
                btn.disabled = false;
                msgDiv.innerText = "âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸï¼";
                msgDiv.style.color = "#2c5e3b";
                
                // UIã‚’å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
                document.getElementById('emailVerifyArea').style.display = 'none';
                document.getElementById('newEmailInput').value = '';
                document.getElementById('emailCodeInput').value = '';
                document.getElementById('emailUpdateArea').style.display = 'block';
            },
            onFailure: function(err) {
                btn.disabled = false;
                msgDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err));
                msgDiv.style.color = "red";
            }
        });
    }

    // 3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹å‡¦ç†
    function changePassword() {
        const oldPassword = document.getElementById('oldPasswordInput').value;
        const newPassword = document.getElementById('newPasswordInput').value;
        const msgDiv = document.getElementById('msgPassword');
        const btn = document.getElementById('btnPassword');

        if (!oldPassword || !newPassword) { msgDiv.innerText = "â€»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"; msgDiv.style.color = "red"; return; }
        
        btn.disabled = true;
        msgDiv.innerText = "æ›´æ–°ä¸­...";
        msgDiv.style.color = "#333";

        cognitoUser.changePassword(oldPassword, newPassword, function(err, result) {
            btn.disabled = false;
            if (err) {
                msgDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + (err.message || JSON.stringify(err));
                msgDiv.style.color = "red";
                return;
            }
            msgDiv.innerText = "âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼";
            msgDiv.style.color = "#2c5e3b";
            document.getElementById('oldPasswordInput').value = '';
            document.getElementById('newPasswordInput').value = '';
        });
    }
</script>

</body>
</html>