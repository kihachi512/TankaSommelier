<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰ï½œä»Šã®æ°—åˆ†ã«å¯„ã‚Šæ·»ã†ä¸€é¦–ã‚’AIãŒé¸æ­Œ</title>
    <meta name="description" content="ã€Œã„ã„ã­ã€ã‚‚è©•ä¾¡ã‚‚ãªã„ã€é™ã‹ãªçŸ­æ­Œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€‚ä»Šã®æ°—åˆ†ã‚’ä¼ãˆã‚‹ã¨ã€AIã‚½ãƒ ãƒªã‚¨ãŒã¿ã‚“ãªã®æŠ•ç¨¿ã®ä¸­ã‹ã‚‰ã‚ãªãŸã«å¯„ã‚Šæ·»ã†ä¸€é¦–ã‚’ã”æ¡ˆå†…ã—ã¾ã™ã€‚">
    <meta name="keywords" content="çŸ­æ­Œ,AI,ã‚½ãƒ ãƒªã‚¨,æ–‡èŠ¸,ã•ã™ã‚‰ã„ã®ãƒ¢ãƒ¢ãƒ³ã‚¬ã‚«ãƒ¼ãƒ‹ãƒãƒ«,ç™’ã‚„ã—">

    <meta property="og:title" content="çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰">
    <meta property="og:description" content="æ•°å­—ã‚„è©•ä¾¡ã‚’æ°—ã«ã›ãšã€ãŸã ç´”ç²‹ã«è¨€è‘‰ã¨å‡ºä¼šã†ã€‚ä»Šã®ã‚ãªãŸã®æ°—åˆ†ã«å¯„ã‚Šæ·»ã†çŸ­æ­Œã‚’AIãŒé¸æ­Œã—ã¾ã™ã€‚">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tankasommelier.momongacarnival.com">
    <meta property="og:image" content="https://momongacarnival.com/assets/sommelier-ogp.png"> <meta property="og:site_name" content="ã•ã™ã‚‰ã„ã®ãƒ¢ãƒ¢ãƒ³ã‚¬ã‚«ãƒ¼ãƒ‹ãƒãƒ«">
    
    <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@kihachi512"> <meta name="twitter:title" content="çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰">
    <meta name="twitter:description" content="ã€Œã„ã„ã­ã€ã®ãªã„ä¸–ç•Œã§ã€è¨€è‘‰ã¨å‡ºä¼šã†ã€‚ä»Šã®æ°—åˆ†ã«ã´ã£ãŸã‚Šã®ä¸€é¦–ã‚’AIãŒé¸ã‚“ã§ãã‚Œã¾ã™ã€‚">
    <meta name="twitter:image" content="https://momongacarnival.com/assets/sommelier-ogp.png">

    <link rel="icon" href="https://momongacarnival.com/assets/momonga-500x500.png">
    <link rel="apple-touch-icon" href="https://momongacarnival.com/assets/momonga-500x500.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=RocknRoll+One&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="style.css">
    
    <style>
        .auth-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="container">
        
        <div id="userStatusBar" style="text-align: right; margin-bottom: 15px; font-size: 0.9em;">
            </div>

        <h1 style="margin-top: 0;">ğŸµ çŸ­æ­Œã‚½ãƒ ãƒªã‚¨ï¼ˆÎ²ç‰ˆï¼‰</h1>
        
        <h3>ã¿ã‚“ãªãŒæŠ•ç¨¿ã—ãŸçŸ­æ­Œã®ä¸­ã‹ã‚‰ã€<br>AIã‚½ãƒ ãƒªã‚¨ãŒä»Šã®ã‚ãªãŸã«å¯„ã‚Šæ·»ã†ä¸€é¦–ã‚’æ¡ˆå†…ã—ã¾ã™ã€‚</h3>
        
        <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
            <p>ä»Šã®ã‚ãªãŸã®æ°—åˆ†ã‚„æƒ…æ™¯ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚</p>
            <textarea id="moodInput" placeholder="ä¾‹ï¼šé›¨ã®éŸ³ã‚’èããªãŒã‚‰ã€å°‘ã—æ„Ÿå‚·çš„ãªæ°—åˆ†..."></textarea>
            <br>
            <button id="getBtn" onclick="getTanka()">é¸æ­Œã—ã¦ã‚‚ã‚‰ã†</button>
            <div id="loading" class="loading">ã‚½ãƒ ãƒªã‚¨ãŒã‚ãªãŸã®ãŸã‚ã®ä¸€é¦–ã‚’é¸æ­Œã—ã¦ã„ã¾ã™...</div>
            <div id="result"></div>
        </div>

        <div style="background: #eef5ee; padding: 20px; border-radius: 8px; position: relative;">
            <h3 style="margin-top: 0; color: #2c5e3b;">âœ’ï¸ ã‚ãªãŸã®çŸ­æ­Œã‚’æŠ•ç¨¿ã™ã‚‹</h3>
            <p style="font-size: 0.85em; color: #555;">ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ãƒã‚¤ãƒšãƒ¼ã‚¸ã«è‡ªåˆ†ã®çŸ­æ­ŒãŒè¨˜éŒ²ã•ã‚Œã¾ã™ã€‚<br>æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆã¯ã€Œè© ã¿äººçŸ¥ã‚‰ãšã€ã¨ã—ã¦æŠ•ç¨¿ã•ã‚Œã¾ã™ã€‚</p>
            
            <input type="text" id="postAuthor" class="auth-input" disabled style="background: #e0e0e0; font-weight: bold;">
            <textarea id="postTanka" placeholder="çŸ­æ­Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            <br>
            <button id="postBtn" onclick="postTanka()" style="background-color: #4CAF50;">æŠ•ç¨¿ã™ã‚‹</button>
            <div id="postResult" style="margin-top: 15px; font-weight: bold; text-align: center;"></div>
        </div>
    </div>

      <footer style="margin-top: 80px; text-align: center; font-size: 0.85rem; color: var(--border-color);">
        <ul style="list-style: none; padding: 0; display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">
          <li><a href="https://momongacarnival.com/privacy/index.html" style="color: var(--border-color); text-decoration: underline;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a></li>
          <li><a href="https://momongacarnival.com/contact/index.html" style="color: var(--border-color); text-decoration: underline;">ãŠå•ã„åˆã‚ã›</a></li>
        </ul>
        <p>&copy; ã•ã™ã‚‰ã„ã®ãƒ¢ãƒ¢ãƒ³ã‚¬ã‚«ãƒ¼ãƒ‹ãƒãƒ«</p>
      </footer>
</div>

<script>
    const GET_API_URL = "https://3ksw35h88a.execute-api.ap-northeast-1.amazonaws.com/recommend";
    const POST_API_URL = "https://y004ehl6p5.execute-api.ap-northeast-1.amazonaws.com/default/tanka-posting";

    // ç”»é¢ã‚’é–‹ã„ãŸæ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
    function checkLoginStatus() {
        const nickname = localStorage.getItem('tanka_nickname');
        const sub = localStorage.getItem('tanka_sub'); // â˜…è¿½åŠ ï¼šè¨˜æ†¶ã—ãŸå›ºæœ‰IDã‚’å‘¼ã³å‡ºã™
        const statusBar = document.getElementById('userStatusBar');
        const postAuthor = document.getElementById('postAuthor');
        
        if (nickname && sub) {
            // â˜…å¤‰æ›´ï¼šauthor.html ã¸ã®ãƒªãƒ³ã‚¯ã« user_id ã‚‚å«ã‚ã‚‹
            statusBar.innerHTML = `
                ã‚ˆã†ã“ãã€<a href="author.html?user_id=${encodeURIComponent(sub)}&author=${encodeURIComponent(nickname)}" style="color: #2c5e3b; font-weight: bold;">${nickname}</a> ã•ã‚“ï¼
                <span style="color: #ccc; margin: 0 5px;">|</span>
                <a href="settings.html" style="color: #555; text-decoration: none;">âš™ï¸ è¨­å®š</a>
                <span style="color: #ccc; margin: 0 5px;">|</span>
                <a href="#" onclick="logOut()" style="color: #7f8c8d; text-decoration: none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
            `;
            postAuthor.value = nickname; 
        } else {
            statusBar.innerHTML = `<a href="login.html" style="color: #d35400; font-weight: bold; text-decoration: none;">ğŸ‘¤ æ–°è¦ç™»éŒ² / ãƒ­ã‚°ã‚¤ãƒ³</a>`;
            postAuthor.value = 'è© ã¿äººçŸ¥ã‚‰ãš'; 
        }
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è¨˜æ†¶ã‚’æ¶ˆã—ã¦å†èª­ã¿è¾¼ã¿ï¼‰
    function logOut() {
        localStorage.removeItem('tanka_nickname');
        localStorage.removeItem('tanka_access_token');
        localStorage.removeItem('tanka_sub'); // â˜…è¿½åŠ ï¼šãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«å›ºæœ‰IDã‚‚æ¶ˆã™
        Object.keys(localStorage).forEach(key => {
            if(key.startsWith('CognitoIdentityServiceProvider')) localStorage.removeItem(key);
        });
        location.reload(); 
    }

    window.onload = checkLoginStatus;

// ==========================================
    // é¸æ­Œï¼ˆã‚½ãƒ ãƒªã‚¨ï¼‰æ©Ÿèƒ½
    // ==========================================
    async function getTanka() {
        const mood = document.getElementById('moodInput').value;
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');
        const submitBtn = document.getElementById('getBtn');

        if (!mood) { alert("æ°—åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã­ã€‚"); return; }

        submitBtn.disabled = true;
        resultDiv.style.display = 'none';
        loadingDiv.style.display = 'block';
        resultDiv.innerHTML = ''; 

        try {
            const response = await fetch(GET_API_URL, {
                method: 'POST',
                // â˜…é¸æ­ŒAPIã«ã¯èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒä¸è¦ãªã®ã§ã€ç›´æ¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›¸ãã¾ã™
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mood: mood })
            });

            if (!response.ok) throw new Error('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');

            const data = await response.json();
            resultDiv.innerText = data.reply;
            
            // â˜…å¤‰æ›´ï¼šè© ã¿äººçŸ¥ã‚‰ãšï¼ˆanonymousï¼‰ã˜ã‚ƒãªã„æ™‚ã ã‘ãƒœã‚¿ãƒ³ã‚’å‡ºã™
            if (data.author && data.user_id && data.user_id !== 'anonymous') {
                const linkBtn = document.createElement('button');
                linkBtn.innerText = `âœ’ï¸ ${data.author} ã®æŠ•ç¨¿ä¸€è¦§ã‚’è¦‹ã‚‹`;
                linkBtn.style.marginTop = '20px';
                linkBtn.style.backgroundColor = '#2c5e3b';
                linkBtn.style.color = 'white';
                linkBtn.style.border = 'none';
                linkBtn.style.padding = '8px 12px';
                linkBtn.style.borderRadius = '4px';
                linkBtn.style.cursor = 'pointer';
                
                // â˜…å¤‰æ›´ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã« user_id ã‚‚æ¸¡ã™
                linkBtn.onclick = () => { window.location.href = `author.html?user_id=${encodeURIComponent(data.user_id)}&author=${encodeURIComponent(data.author)}`; };
                
                resultDiv.appendChild(document.createElement('br'));
                resultDiv.appendChild(linkBtn);
            }

            resultDiv.style.display = 'block';
        } catch (error) {
            resultDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + error.message;
            resultDiv.style.display = 'block';
        } finally {
            loadingDiv.style.display = 'none';
            submitBtn.disabled = false;
        }
    }

    // ==========================================
    // æŠ•ç¨¿æ©Ÿèƒ½
    // ==========================================
    async function postTanka() {
        const tanka = document.getElementById('postTanka').value;
        const postResultDiv = document.getElementById('postResult');
        const postBtn = document.getElementById('postBtn');

        if (!tanka) { alert("â€»çŸ­æ­Œã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        postBtn.disabled = true;
        postBtn.innerText = 'é€ä¿¡ä¸­...';
        postResultDiv.innerText = '';

        try {
            const accessToken = localStorage.getItem('tanka_access_token');
            
            // â˜…æŠ•ç¨¿æ©Ÿèƒ½ã§ã¯ã€ã“ã“ã§ã€Œheadersã€ã¨ã„ã†å¤‰æ•°ã‚’ä½œã£ã¦ã‹ã‚‰ä½¿ã£ã¦ã„ã¾ã™
            const headers = { 'Content-Type': 'application/json' };
            if (accessToken) headers['Authorization'] = accessToken;

            const response = await fetch(POST_API_URL, {
                method: 'POST',
                headers: headers, // â˜…å¤‰æ•°ã¨ã—ã¦ã‚»ãƒƒãƒˆ
                body: JSON.stringify({ tanka: tanka }) 
            });

            // â˜…401ã‚¨ãƒ©ãƒ¼ï¼ˆæœ‰åŠ¹æœŸé™åˆ‡ã‚Œï¼‰ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (response.status === 401) {
                alert("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚ãŠæ‰‹æ•°ã§ã™ãŒã€å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™ğŸµ");
                logOut(); // å¤ã„ãƒ‘ã‚¹ã‚’ç ´æ£„
                window.location.href = 'login.html';
                return;
            }

            if (!response.ok) throw new Error('â€»é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');

            const data = await response.json();
            postResultDiv.innerText = data.message;
            postResultDiv.style.color = "#2c5e3b";
            document.getElementById('postTanka').value = '';
            
        } catch (error) {
            postResultDiv.innerText = "â€»ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
            postResultDiv.style.color = "red";
        } finally {
            setTimeout(() => {
                postBtn.disabled = false;
                postBtn.innerText = 'æŠ•ç¨¿ã™ã‚‹';
            }, 3000);
        }
    }
</script>

</body>
</html>